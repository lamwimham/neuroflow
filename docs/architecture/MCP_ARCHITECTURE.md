# MCP 架构可视化

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        NeuroFlow Application                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    Python SDK Layer                             │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  装饰器 API                                               │  │    │
│  │  │  • @mcp_tool(server, tool_name)                          │  │    │
│  │  │  • @mcp_resource(uri_pattern)                            │  │    │
│  │  │  • @agent_with_mcp(servers=[...])                        │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  MCPClient (统一客户端)                                   │  │    │
│  │  │  • initialize()      - 初始化所有连接                     │  │    │
│  │  │  • call_tool()       - 调用工具                          │  │    │
│  │  │  • list_tools()      - 列出工具                          │  │    │
│  │  │  • execute_tool()    - 执行工具                          │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  类型验证层                                               │  │    │
│  │  │  • JSON Schema 验证                                       │  │    │
│  │  │  • 参数类型检查                                           │  │    │
│  │  │  • 错误处理和重试                                         │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    Rust Kernel Layer                            │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  MCP Gateway                                              │  │    │
│  │  │  ┌─────────────────┐  ┌─────────────────┐                │  │    │
│  │  │  │  Connection     │  │  Connection     │                │  │    │
│  │  │  │  Pool           │  │  Manager        │                │  │    │
│  │  │  │  (连接复用)     │  │  (生命周期)     │                │  │    │
│  │  │  └─────────────────┘  └─────────────────┘                │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  Tool Router                                              │  │    │
│  │  │  ┌─────────────────┐  ┌─────────────────┐                │  │    │
│  │  │  │  Name-based     │  │  Semantic       │                │  │    │
│  │  │  │  Routing        │  │  Routing        │                │  │    │
│  │  │  │  (server:tool)  │  │  (意图匹配)     │                │  │    │
│  │  │  └─────────────────┘  └─────────────────┘                │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  Observability (可观测性)                                 │  │    │
│  │  │  • Metrics: 工具调用次数、延迟、错误率                    │  │    │
│  │  │  • Tracing: 完整链路追踪                                  │  │    │
│  │  │  • Logging: 结构化日志                                    │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
└───────────────────────────────────┼─────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
        ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
        │  Filesystem   │ │   Database    │ │  Custom API   │
        │  MCP Server   │ │  MCP Server   │ │  MCP Server   │
        │  (npx/python) │ │  (python)     │ │  (HTTP)       │
        └───────────────┘ └───────────────┘ └───────────────┘
                │                 │                 │
                ▼                 ▼                 ▼
        ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
        │  • read_file  │ │  • query      │ │  • greet      │
        │  • write_file │ │  • insert     │ │  • calculate  │
        │  • list_dir   │ │  • update     │ │  • ...        │
        │  • delete     │ │  • delete     │ │               │
        └───────────────┘ └───────────────┘ └───────────────┘
```

## 数据流图

### 工具调用流程

```
┌──────────┐
│  Agent   │
└────┬─────┘
     │ 1. 调用工具
     ▼
┌─────────────────────────────────────┐
│  @mcp_tool 装饰器                   │
│  • 参数验证                          │
│  • 类型检查                          │
└────────────┬────────────────────────┘
             │ 2. 转发调用
             ▼
┌─────────────────────────────────────┐
│  MCPClient.call_tool()              │
│  • 查找工具信息                      │
│  • 构建 JSON-RPC 请求                 │
│  • 添加认证头                        │
└────────────┬────────────────────────┘
             │ 3. HTTP 请求
             ▼
┌─────────────────────────────────────┐
│  MCP Gateway (Rust)                 │
│  • 连接池获取连接                    │
│  • 负载均衡                          │
│  • 熔断检查                          │
└────────────┬────────────────────────┘
             │ 4. 转发请求
             ▼
┌─────────────────────────────────────┐
│  MCP Server                         │
│  • 解析 JSON-RPC                     │
│  • 执行工具逻辑                      │
│  • 返回结果                          │
└────────────┬────────────────────────┘
             │ 5. 返回结果
             ▼
┌─────────────────────────────────────┐
│  MCPClient                          │
│  • 解析响应                          │
│  • 错误处理                          │
│  • 缓存结果 (可选)                   │
└────────────┬────────────────────────┘
             │ 6. 返回给 Agent
             ▼
┌──────────┐
│  Agent   │
│  处理结果 │
└──────────┘
```

## 配置层次图

```
┌─────────────────────────────────────────┐
│  config/mcp.yaml                        │
│                                         │
│  mcp:                                   │
│    ├─ global (全局设置)                 │
│    │   ├─ timeout_ms: 30000            │
│    │   ├─ max_connections: 100         │
│    │   └─ api_key: ${MCP_API_KEY}      │
│    │                                    │
│    └─ servers (服务器配置)              │
│        ├─ filesystem                    │
│        │   ├─ enabled: true            │
│        │   ├─ command: npx             │
│        │   ├─ args: [...]              │
│        │   ├─ http_port: 8081          │
│        │   └─ tools: [...]             │
│        │                               │
│        ├─ database                      │
│        │   ├─ enabled: true            │
│        │   ├─ command: python          │
│        │   └─ ...                      │
│        │                               │
│        └─ custom                        │
│            ├─ enabled: false           │
│            ├─ url: https://...         │
│            └─ auth:                    │
│                ├─ type: bearer         │
│                └─ token: ${TOKEN}      │
└─────────────────────────────────────────┘
```

## 工具注册流程图

```
┌─────────────┐
│  应用启动   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────┐
│ MCPClient.initialize()  │
└──────┬──────────────────┘
       │
       ├─────────────────────────────────┐
       │                                 │
       ▼                                 ▼
┌──────────────────┐          ┌──────────────────┐
│ 加载配置文件     │          │ 加载环境变量     │
│ (YAML/JSON)      │          │ (${VAR})         │
└──────┬───────────┘          └──────┬───────────┘
       │                             │
       └──────────┬──────────────────┘
                  │
                  ▼
       ┌──────────────────────┐
       │ 遍历服务器配置       │
       │ for each server:     │
       └──────┬───────────────┘
              │
              ▼
       ┌──────────────────────┐
       │ 启动/连接服务器      │
       │ • 本地：启动进程     │
       │ • 远程：HTTP 连接     │
       └──────┬───────────────┘
              │
              ▼
       ┌──────────────────────┐
       │ 获取工具列表         │
       │ GET /mcp/tools/list  │
       └──────┬───────────────┘
              │
              ▼
       ┌──────────────────────┐
       │ 注册工具到本地       │
       │ tools[name] = info   │
       └──────┬───────────────┘
              │
              ▼
       ┌──────────────────────┐
       │ 所有服务器连接完成   │
       └──────────────────────┘
```

## 错误处理层次图

```
┌────────────────────────────────────────────┐
│  MCPError (基础异常)                       │
│                                            │
│  ├─ MCPConnectionError                     │
│  │   ├─ 连接超时                           │
│  │   ├─ 连接拒绝                           │
│  │   └─ 网络不可达                         │
│  │                                         │
│  ├─ MCPTimeoutError                        │
│  │   ├─ 请求超时                           │
│  │   └─ 读取超时                           │
│  │                                         │
│  ├─ MCPNotFoundError                       │
│  │   ├─ 服务器不存在                       │
│  │   └─ 工具不存在                         │
│  │                                         │
│  ├─ MCPValidationError                     │
│  │   ├─ 参数类型错误                       │
│  │   ├─ 缺少必需参数                       │
│  │   └─ 参数格式错误                       │
│  │                                         │
│  ├─ MCPAuthenticationError                 │
│  │   ├─ 认证失败                           │
│  │   └─ 权限不足                           │
│  │                                         │
│  └─ MCPToolExecutionError                  │
│      ├─ 工具执行失败                       │
│      ├─ 工具返回错误                       │
│      └─ 资源不可用                         │
└────────────────────────────────────────────┘
```

## 并发模型图

```
┌─────────────────────────────────────────────────────┐
│  Async Event Loop                                   │
│                                                      │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐   │
│  │ Task 1 │  │ Task 2 │  │ Task 3 │  │ Task 4 │   │
│  │ (Agent)│  │ (Agent)│  │ (Agent)│  │ (Agent)│   │
│  └───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘   │
│      │           │           │           │         │
│      └───────────┴───────────┴───────────┘         │
│                      │                              │
│                      ▼                              │
│      ┌───────────────────────────────┐             │
│      │   MCPClient (共享实例)        │             │
│      │   • 连接池 (max=100)          │             │
│      │   • 信号量 (并发控制)         │             │
│      └───────────────┬───────────────┘             │
│                      │                              │
│      ┌───────────────┴───────────────┐             │
│      │                               │             │
│      ▼                               ▼             │
│  ┌─────────┐                    ┌─────────┐       │
│  │ Server 1│                    │ Server 2│       │
│  │ (FS)    │                    │ (DB)    │       │
│  └─────────┘                    └─────────┘       │
└─────────────────────────────────────────────────────┘

并发控制:
• Semaphore 限制最大并发连接数
• 连接池复用 HTTP 连接
• asyncio.gather() 并发调用
```

## 部署架构图

```
┌──────────────────────────────────────────────────────┐
│  Production Environment                              │
│                                                       │
│  ┌────────────────────────────────────────────────┐ │
│  │  Kubernetes Cluster                            │ │
│  │                                                 │ │
│  │  ┌──────────────────────────────────────────┐ │ │
│  │  │  NeuroFlow Pod                           │ │ │
│  │  │  ┌────────────┐  ┌────────────┐         │ │ │
│  │  │  │ Rust       │  │ Python     │         │ │ │
│  │  │  │ Gateway    │◄─┤ SDK        │         │ │ │
│  │  │  │ (MCP       │  │ (Agent     │         │ │ │
│  │  │  │  Client)   │  │  Runtime)  │         │ │ │
│  │  │  └────────────┘  └────────────┘         │ │ │
│  │  └──────────────────────────────────────────┘ │ │
│  │                                                 │ │
│  │  ┌──────────────────────────────────────────┐ │ │
│  │  │  MCP Servers (Sidecar)                   │ │ │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ │ │ │
│  │  │  │Filesystem│ │ Database │ │ Custom   │ │ │ │
│  │  │  │Server    │ │ Server   │ │ Server   │ │ │ │
│  │  │  └──────────┘ └──────────┘ └──────────┘ │ │ │
│  │  └──────────────────────────────────────────┘ │ │
│  │                                                 │ │
│  └─────────────────────────────────────────────────┘ │
│                                                       │
│  ┌─────────────────────────────────────────────────┐ │
│  │  External MCP Services                          │ │
│  │  • cloud-api.example.com/mcp                   │ │
│  │  • third-party-service.com/mcp                 │ │
│  └─────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘
```

## 监控指标图

```
┌─────────────────────────────────────────────────┐
│  MCP Observability Stack                        │
│                                                  │
│  Metrics (Prometheus)                           │
│  ┌───────────────────────────────────────────┐ │
│  │ • mcp_tool_calls_total                    │ │
│  │   - labels: server, tool, status          │ │
│  │                                           │ │
│  │ • mcp_tool_duration_seconds               │ │
│  │   - labels: server, tool                  │ │
│  │                                           │ │
│  │ • mcp_active_connections                  │ │
│  │   - labels: server                        │ │
│  │                                           │ │
│  │ • mcp_errors_total                        │ │
│  │   - labels: server, tool, error_type      │ │
│  └───────────────────────────────────────────┘ │
│                                                  │
│  Tracing (Jaeger/Zipkin)                        │
│  ┌───────────────────────────────────────────┐ │
│  │  Span: mcp.{server}.{tool}                │ │
│  │  Attributes:                              │ │
│  │  • mcp.server                             │ │
│  │  • mcp.tool                               │ │
│  │  • mcp.arguments                          │ │
│  │  • mcp.duration                           │ │
│  └───────────────────────────────────────────┘ │
│                                                  │
│  Logging (ELK/Loki)                             │
│  ┌───────────────────────────────────────────┐ │
│  │ 结构化日志：                              │ │
│  │ {                                        │ │
│  │   "timestamp": "...",                    │ │
│  │   "level": "INFO",                       │ │
│  │   "component": "mcp",                    │ │
│  │   "server": "filesystem",                │ │
│  │   "tool": "read_file",                   │ │
│  │   "duration_ms": 45,                     │ │
│  │   "status": "success"                    │ │
│  │ }                                        │ │
│  └───────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

这些图表展示了 NeuroFlow MCP 集成的完整架构和工作流程。
