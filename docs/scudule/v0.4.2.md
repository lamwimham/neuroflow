# 📋 NeuroFlow v0.4.2 开发计划
## 真实连接与协作能力专项

**文档版本**: 1.0  
**创建日期**: 2026-03-05  
**执行周期**: 2 周 (10 个工作日)  
**版本号**: v0.4.2  
**前置版本**: v0.4.1 ✅

---

## 🎯 项目概述

### 背景
v0.4.1 已完成 Agent 模板系统和 MCP 基础集成，但部分功能仍使用模拟实现。v0.4.2 的核心目标是 **打通真实连接**，让 Agent 能够与真实 MCP 服务器通信、实现真实的 Agent 间协作。

### 目标
| 目标 | 描述 | 优先级 |
|------|------|--------|
| **真实 MCP 集成** | 移除模拟代码，连接真实 MCP 服务器 | P0 |
| **A2A 真实通信** | 实现 Agent 间 HTTP/gRPC 通信 | P0 |
| **沙箱安全增强** | 强化 Terminal 沙箱隔离 | P0 |
| **示例完善** | 提供 5+ 个完整可运行示例 | P1 |

### 核心价值
- ✅ 生产可用性提升，移除所有模拟代码
- ✅ 多 Agent 协作能力真实可用
- ✅ 安全性达到生产标准

---

## 📊 v0.4.1 完成情况回顾

| 模块 | 完成状态 | 备注 |
|------|----------|------|
| Agent 模板系统 | ✅ 100% | basic/standard/advanced 模板完成 |
| MCP 基础集成 | ✅ 80% | 配置解析完成，部分模拟代码 |
| Terminal 安全 | ✅ 90% | 白名单/沙箱完成，需增强 |
| CLI 增强 | ✅ 100% | agent create 命令完善 |
| 文档 | ✅ 90% | 核心文档完成 |

**遗留问题**:
1. MCP 服务器连接使用部分模拟代码
2. A2A 通信框架完成但未真实测试
3. Terminal 沙箱需增强隔离级别

---

## 📦 工作分解结构 (WBS)

### 模块 1: 真实 MCP 集成 (Python SDK 组)

| ID | 任务 | 描述 | 负责人 | 工时 | 优先级 |
|:---|------|------|--------|:----:|:------:|
| **MCP-101** | 移除 MCP 模拟代码 | 清理 v0.4.1 中的 mock 实现 | 后端开发 A | 4h | P0 |
| **MCP-102** | 真实 filesystem MCP 连接 | 测试并集成官方 filesystem 服务器 | 后端开发 A | 6h | P0 |
| **MCP-103** | 真实 memory MCP 连接 | 测试并集成官方 memory 服务器 | 后端开发 A | 6h | P0 |
| **MCP-104** | MCP 连接池管理 | 实现 MCP 连接复用和超时管理 | 后端开发 B | 8h | P1 |
| **MCP-105** | MCP 错误处理 | 完善连接失败、超时、重试逻辑 | 后端开发 B | 6h | P0 |
| **MCP-106** | 新增 MCP 服务器模板 | 添加 brave-search, fetch 服务器配置模板 | 后端开发 A | 4h | P2 |

### 模块 2: A2A 真实通信 (Python SDK 组 + Rust Kernel 组)

| ID | 任务 | 描述 | 负责人 | 工时 | 优先级 |
|:---|------|------|--------|:----:|:------:|
| **A2A-101** | Agent 注册服务 | 实现轻量级 Agent 注册中心 (内存/Redis) | 后端开发 B | 8h | P0 |
| **A2A-102** | HTTP 通信协议 | 定义 Agent 间 HTTP API 协议 | 后端开发 B | 6h | P0 |
| **A2A-103** | gRPC 通信协议 | 实现 gRPC 通信 (Rust Kernel) | Rust 开发 A | 12h | P1 |
| **A2A-104** | 协作编排器增强 | 完善 CollaborativeOrchestrator 真实调用 | 后端开发 A | 8h | P0 |
| **A2A-105** | 协作深度限制 | 防止无限递归调用 (max_depth=5) | 后端开发 A | 4h | P0 |
| **A2A-106** | 协作超时控制 | 单次协作请求超时限制 | 后端开发 B | 4h | P1 |

### 模块 3: 沙箱安全增强 (Rust Kernel 组)

| ID | 任务 | 描述 | 负责人 | 工时 | 优先级 |
|:---|------|------|--------|:----:|:------:|
| **SEC-101** | 文件系统隔离增强 | 使用 chroot 或 namespace 隔离工作目录 | Rust 开发 A | 12h | P0 |
| **SEC-102** | 网络访问控制 | 限制沙箱内网络访问 (可选) | Rust 开发 A | 8h | P1 |
| **SEC-103** | 资源限制强化 | CPU/内存/时间严格限制 | Rust 开发 A | 8h | P0 |
| **SEC-104** | 安全审计日志 | 记录所有 Terminal 操作日志 | 后端开发 B | 6h | P1 |
| **SEC-105** | 安全测试用例 | 编写沙箱逃逸测试用例 | QA 工程师 | 8h | P0 |

### 模块 4: 示例与模板 (Python SDK 组)

| ID | 任务 | 描述 | 负责人 | 工时 | 优先级 |
|:---|------|------|--------|:----:|:------:|
| **EXM-101** | 单 Agent 示例 | 完善 personal-assistant 示例 | 后端开发 A | 4h | P0 |
| **EXM-102** | 多 Agent 协作示例 | 创建 researcher+writer 协作示例 | 后端开发 A | 8h | P0 |
| **EXM-103** | 数据分析示例 | 创建 data-analysis 完整示例 | 后端开发 B | 6h | P1 |
| **EXM-104** | 代码审查示例 | 创建 code-review 完整示例 | 后端开发 B | 6h | P1 |
| **EXM-105** | 示例文档 | 为每个示例编写 README 和使用说明 | 技术文档 | 8h | P0 |

### 模块 5: 文档与测试 (文档组 + QA)

| ID | 任务 | 描述 | 负责人 | 工时 | 优先级 |
|:---|------|------|--------|:----:|:------:|
| **DOC-101** | MCP 集成文档更新 | 更新真实 MCP 配置说明 | 技术文档 | 4h | P0 |
| **DOC-102** | A2A 协作指南 | 编写多 Agent 协作教程 | 技术文档 | 6h | P0 |
| **DOC-103** | 安全最佳实践 | 更新 Terminal 安全文档 | 技术文档 | 4h | P0 |
| **QA-101** | MCP 集成测试 | 真实 MCP 服务器连接测试 | QA 工程师 | 8h | P0 |
| **QA-102** | A2A 协作测试 | 多 Agent 通信测试 | QA 工程师 | 8h | P0 |
| **QA-103** | 安全渗透测试 | 沙箱逃逸尝试测试 | QA 工程师 | 12h | P0 |
| **QA-104** | 性能基准测试 | 建立性能基线 | QA 工程师 | 6h | P2 |

---

## 📅 时间线与里程碑

```
Week 1                          Week 2
├─────┬─────┬─────┬─────┬─────┼─────┬─────┬─────┬─────┬─────┤
  D1    D2    D3    D4    D5    D6    D7    D8    D9   D10
  │     │     │     │     │     │     │     │     │     │
  ▼     ▼     ▼     ▼     ▼     ▼     ▼     ▼     ▼     ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────┐
│   MCP 真实集成  │   │   A2A 通信      │   │  测试与发布  │
│   MCP-101~106   │   │   A2A-101~106   │   │  QA-101~104 │
│   SEC-101~103   │   │   EXM-101~105   │   │  DOC-101~103│
└─────────────────┘   └─────────────────┘   └─────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
   M1: MCP 完成          M2: A2A 完成          M3: 发布就绪
   (D4 结束)             (D7 结束)             (D10 结束)
```

### 里程碑定义

| 里程碑 | 时间点 | 交付物 | 验收标准 |
|--------|--------|--------|----------|
| **M1: MCP 完成** | Day 4 | 真实 MCP 连接可用 | 无模拟代码，真实 filesystem/memory 连接成功 |
| **M2: A2A 完成** | Day 7 | 多 Agent 协作可用 | 2+ Agent 可真实通信协作完成任务 |
| **M3: 发布就绪** | Day 10 | 测试通过 + 文档完整 | 所有测试通过，5+ 示例可运行 |

---

## ✅ 验收标准

### 功能验收

| 编号 | 测试场景 | 预期结果 | 优先级 |
|------|----------|----------|--------|
| **ACC-201** | MCP filesystem 连接 | 成功连接官方 MCP 服务器 | P0 |
| **ACC-202** | MCP memory 连接 | 成功连接官方 MCP 服务器 | P0 |
| **ACC-203** | 模拟代码清理 | 代码库中无 mock MCP 实现 | P0 |
| **ACC-204** | Agent 注册 | Agent 可成功注册到注册中心 | P0 |
| **ACC-205** | Agent 间通信 | Agent A 可调用 Agent B 的工具 | P0 |
| **ACC-206** | 协作深度限制 | 超过 max_depth 自动终止 | P0 |
| **ACC-207** | 沙箱隔离 | 无法访问工作目录外文件 | P0 |
| **ACC-208** | 示例运行 | 5+ 示例可完整运行 | P1 |

### 安全验收

| 编号 | 测试场景 | 预期结果 | 优先级 |
|------|----------|----------|--------|
| **SEC-201** | 文件系统逃逸 | 无法访问 /etc, /root 等目录 | P0 |
| **SEC-202** | 网络访问控制 | 沙箱内网络访问受限制 | P1 |
| **SEC-203** | 资源耗尽攻击 | CPU/内存超限自动终止 | P0 |
| **SEC-204** | 命令注入 | 特殊字符命令被正确转义 | P0 |
| **SEC-205** | 协作循环攻击 | 循环调用被检测并终止 | P0 |

### 性能验收

| 编号 | 指标 | 目标值 | 优先级 |
|------|------|--------|--------|
| **PERF-201** | MCP 连接延迟 | < 500ms (首次) | P1 |
| **PERF-202** | A2A 通信延迟 | < 100ms (同机) | P1 |
| **PERF-203** | 沙箱启动时间 | < 100ms | P2 |
| **PERF-204** | 并发 Agent 支持 | > 50 个 Agent | P2 |

---

## 👥 责任分配矩阵 (RACI)

| 任务模块 | 产品经理 | 技术负责人 | Python 开发 | Rust 开发 | QA | 文档 |
|----------|:--------:|:----------:|:-----------:|:---------:|:--:|:----:|
| MCP 真实集成 | C | A | R | C | C | I |
| A2A 通信 | C | A | R | R | C | I |
| 沙箱安全 | C | A | C | R | C | I |
| 示例开发 | I | A | R | - | I | C |
| 文档 | I | I | C | C | I | R |
| 测试 | I | A | C | C | R | I |

**图例**: R=负责执行 | A=最终批准 | C=咨询 | I=知悉

---

## ⚠️ 风险管控

| 风险 | 概率 | 影响 | 缓解措施 | 负责人 |
|------|:----:|:----:|----------|--------|
| 官方 MCP 服务器不稳定 | 中 | 高 | 实现连接重试和降级，准备备用方案 | Python 开发 A |
| A2A 通信协议设计缺陷 | 中 | 高 | 先定义协议文档，评审后再实现 | 技术负责人 |
| 沙箱逃逸漏洞 | 低 | 极高 | 多层防护，外部安全审计 | Rust 开发 A |
| 多 Agent 协作死锁 | 中 | 中 | 实现超时和循环检测 | Python 开发 B |
| 性能不达标 | 中 | 中 | 早期性能测试，及时优化 | QA 工程师 |

---

## 📁 交付物清单

### 代码交付

```
sdk/neuroflow/
├── mcp/
│   ├── connection_pool.py      # 新增：连接池管理
│   ├── real_executor.py        # 新增：真实 MCP 执行器
│   └── health_monitor.py       # 新增：健康监控
├── a2a/
│   ├── registry_service.py     # 增强：注册服务
│   ├── http_protocol.py        # 新增：HTTP 协议
│   └── collaboration_v2.py     # 增强：协作编排 v2
├── sandbox/
│   ├── isolation.py            # 新增：隔离增强
│   └── audit_logger.py         # 新增：审计日志
└── examples/
    ├── personal-assistant/     # 完善：个人助手
    ├── researcher-writer/      # 新增：研究 + 写作协作
    ├── data-analysis/          # 新增：数据分析
    └── code-review/            # 新增：代码审查

kernel/src/
├── a2a/
│   ├── grpc_server.rs          # 新增：gRPC 服务
│   └── protocol.rs             # 新增：协议定义
└── sandbox/
    ├── namespace.rs            # 新增：namespace 隔离
    └── resource_limit.rs       # 新增：资源限制
```

### 文档交付

| 文档 | 路径 | 状态 |
|------|------|------|
| MCP 真实集成指南 | docs-site/docs/guides/mcp-real-integration.md | ⬜ |
| A2A 协作教程 | docs-site/docs/tutorials/multi-agent-collaboration.md | ⬜ |
| 沙箱安全白皮书 | docs-site/docs/security/sandbox-whitepaper.md | ⬜ |
| 示例集合文档 | docs-site/docs/examples/overview.md | ⬜ |
| 发布说明 | docs/RELEASE_NOTES_v0.4.2.md | ⬜ |

### 测试交付

| 测试类型 | 文件 | 覆盖率目标 |
|----------|------|------------|
| MCP 集成测试 | tests/mcp/test_real_connection.py | 85% |
| A2A 通信测试 | tests/a2a/test_collaboration.py | 85% |
| 沙箱安全测试 | tests/security/test_isolation.py | 95% |
| 性能基准测试 | tests/perf/benchmark_v0.4.2.py | - |
| 端到端测试 | tests/e2e/test_multi_agent.py | - |

---

## 🔄 每日站会检查项

### 开发团队每日同步 (15 分钟)

1. **昨天完成了什么？**
2. **今天计划做什么？**
3. **有什么阻塞问题？**

### 关键检查点

| 时间点 | 检查项 | 负责人 |
|--------|--------|--------|
| Day 1 结束 | MCP 模拟代码清理完成 | Python 开发 A |
| Day 4 结束 | M1 里程碑验收 (MCP 集成) | 技术负责人 |
| Day 5 结束 | A2A 协议定义评审 | 技术负责人 |
| Day 7 结束 | M2 里程碑验收 (A2A 通信) | 技术负责人 |
| Day 9 结束 | 所有测试通过 | QA 工程师 |
| Day 10 结束 | M3 里程碑验收，发布 | 技术负责人 |

---

## 📞 沟通与协作

### 沟通渠道
- **日常沟通**: Slack/钉钉 #neuroflow-dev 频道
- **代码审查**: GitHub Pull Request
- **文档协作**: Notion/语雀
- **问题追踪**: GitHub Issues

### 会议安排
| 会议 | 时间 | 参与人 |
|------|------|--------|
| 每日站会 | 每天 10:00 (15 分钟) | 全体开发 |
| 技术评审 | Week 1 Day 3 (1 小时) | 技术负责人 + 开发 |
| 安全评审 | Week 2 Day 2 (1 小时) | Rust 开发 + QA |
| 冲刺评审 | Week 2 Day 10 (1 小时) | 全体 + 产品经理 |

---

## 🚀 启动检查清单

在开发开始前，请确认以下事项：

- [ ] v0.4.1 已正式发布并打 tag
- [ ] GitHub 分支 `feat/v0.4.2-real-connection` 已创建
- [ ] 开发人员已分配并确认任务
- [ ] 官方 MCP 服务器可用性已验证
- [ ] 测试环境准备完成 (含 Redis 用于 A2A 注册)
- [ ] 安全测试工具准备完成

---

## 📊 成功指标

| 指标 | 目标值 | 测量方式 |
|------|--------|----------|
| MCP 连接成功率 | > 99% | 监控日志 |
| A2A 通信延迟 | < 100ms | 性能测试 |
| 安全事故 | 0 | 安全审计 |
| 测试覆盖率 | > 85% | CI/CD 报告 |
| 示例可运行率 | 100% | 手动验证 |
| 文档完整性 | 100% 功能有文档 | 文档审查 |

---

## 🎯 v0.5.0 预览 (下一步规划)

v0.4.2 完成后，v0.5.0 将聚焦于：

| 模块 | 计划内容 | 预计时间 |
|------|----------|----------|
| **性能优化** | Rust Gateway 性能基准与优化 | 2 周 |
| **可观测性** | OpenTelemetry 集成，链路追踪 | 2 周 |
| **Web 控制台** | 管理界面 MVP | 3 周 |
| **Skill 市场** | Skill 模板库和分享机制 | 2 周 |
| **生产部署** | Docker/K8s 部署指南 | 1 周 |

---

**批准签字**:

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| 产品经理 | | | |
| 技术负责人 | | | |
| 开发代表 | | | |

---

**文档结束**

---

## 📝 附：关键技术决策

### A2A 通信协议选择

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| HTTP/REST | 简单，易调试 | 性能一般 | ✅ 默认使用 |
| gRPC | 高性能，强类型 | 配置复杂 | ✅ 可选启用 |
| WebSocket | 实时双向 | 连接管理复杂 | ❌ 暂不使用 |

### Agent 注册中心选择

| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| 内存注册 | 简单，无依赖 | 不支持分布式 | ✅ 开发/单机使用 |
| Redis | 支持分布式，成熟 | 需要额外服务 | ✅ 生产环境使用 |
| etcd | 强一致性 | 复杂度高 | ❌ 暂不使用 |

### 沙箱隔离级别

| 级别 | 实现方式 | 安全性 | 性能 | 决策 |
|------|----------|--------|------|------|
| Level 1 | subprocess 限制 | 低 | 高 | ✅ 默认 |
| Level 2 | Linux namespace | 中 | 中 | ✅ 可选 |
| Level 3 | Docker/gVisor | 高 | 低 | ❌ 后续版本 |

---

**请将此文档分发给开发团队，如有任何问题请及时沟通！** 🚀